<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz System - Guaranteed Working</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background: #f5f5f5; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .section { display: none; }
        .active { display: block; }
        .btn { background: #2563eb; color: white; border: none; padding: 15px; border-radius: 8px; width: 100%; margin: 10px 0; cursor: pointer; font-size: 16px; }
        .btn:hover { background: #1d4ed8; }
        .btn-success { background: #059669; }
        .btn-success:hover { background: #047857; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; }
        input { width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 16px; }
        input:focus { border-color: #2563eb; outline: none; }
        .status { padding: 15px; border-radius: 8px; margin: 15px 0; text-align: center; font-weight: bold; }
        .success { background: #dcfce7; color: #166534; border: 2px solid #bbf7d0; }
        .error { background: #fee2e2; color: #dc2626; border: 2px solid #fecaca; }
        .question { font-size: 20px; margin: 20px 0; text-align: center; }
        .options { display: grid; gap: 10px; margin: 20px 0; }
        .option-btn { padding: 15px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; cursor: pointer; font-size: 16px; }
        .option-btn:hover { border-color: #2563eb; background: #f0f9ff; }
        .option-btn.selected { border-color: #2563eb; background: #dbeafe; }
        .timer { text-align: center; font-size: 18px; font-weight: bold; color: #dc2626; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Welcome Section -->
        <div id="welcome-section" class="section active">
            <h1 style="text-align: center; margin-bottom: 20px; color: #2563eb;">üéØ Secure Quiz System</h1>
            <p style="text-align: center; margin-bottom: 30px; color: #6b7280;">Data will be saved to Google Sheets automatically</p>

            <div class="form-group">
                <label>Full Name</label>
                <input type="text" id="student-name" placeholder="Enter your full name" value="Test Student">
            </div>
            <div class="form-group">
                <label>Email Address</label>
                <input type="email" id="student-email" placeholder="Enter your email" value="test@student.com">
            </div>
            <div class="form-group">
                <label>Student ID</label>
                <input type="text" id="student-id" placeholder="Enter student ID" value="STU123">
            </div>

            <button class="btn btn-success" onclick="testConnection()">üîó TEST CONNECTION</button>
            <button class="btn" onclick="startQuiz()">üöÄ START QUIZ</button>

            <div id="status" class="status"></div>
        </div>

        <!-- Quiz Section -->
        <div id="quiz-section" class="section">
            <h2 style="text-align: center; margin-bottom: 10px;">Question <span id="question-num">1</span>/5</h2>
            <div class="timer">‚è∞ Time: <span id="timer">60</span>s</div>
            <div class="question" id="question-text"></div>
            
            <div class="options" id="options-container">
                <!-- Options will be loaded here -->
            </div>

            <button class="btn" onclick="nextQuestion()" id="next-btn">Next Question</button>
            <div id="quiz-status" class="status"></div>
        </div>

        <!-- Results Section -->
        <div id="results-section" class="section">
            <h1 style="text-align: center; color: #059669; margin-bottom: 20px;">üéâ Quiz Completed!</h1>
            <div style="text-align: center; font-size: 48px; font-weight: bold; color: #2563eb; margin: 20px 0;" id="final-score"></div>
            <div class="status success" id="results-message">All data has been saved to Google Sheets! ‚úÖ</div>
            <button class="btn" onclick="restartQuiz()">üîÑ Take Another Quiz</button>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz04R6QL0fDvBo1u0PfQiLzz1r2HxbkdQfNQu-2KTQLtyxoz8fspD06aLa86PYTRb_g/exec'; // Replace after deployment
        
        let currentQuestion = 0;
        let score = 0;
        let timeLeft = 60;
        let timer;
        let sessionId = '';
        let studentData = {};

        const questions = [
            {
                question: "What is the capital of France?",
                options: ["London", "Berlin", "Paris", "Madrid"],
                correct: 2
            },
            {
                question: "Which planet is known as the Red Planet?",
                options: ["Venus", "Mars", "Jupiter", "Saturn"],
                correct: 1
            },
            {
                question: "What is the largest mammal in the world?",
                options: ["Elephant", "Blue Whale", "Giraffe", "Polar Bear"],
                correct: 1
            },
            {
                question: "Who wrote 'Romeo and Juliet'?",
                options: ["Charles Dickens", "William Shakespeare", "Jane Austen", "Mark Twain"],
                correct: 1
            },
            {
                question: "What is the chemical symbol for gold?",
                options: ["Go", "Gd", "Au", "Ag"],
                correct: 2
            }
        ];

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }

        // Test connection to Google Apps Script
        async function testConnection() {
            showStatus('Testing connection...', '');
            
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({action: 'test'})
                });
                
                const result = await response.json();
                showStatus('‚úÖ CONNECTION SUCCESSFUL! Script is working.', 'success');
                console.log('Connection test result:', result);
                
            } catch (error) {
                showStatus('‚ùå Connection failed: ' + error.message, 'error');
            }
        }

        // Save data to Google Sheets
        async function saveToSheets(data) {
            try {
                console.log('Saving data:', data);
                
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        action: 'saveData',
                        ...data
                    })
                });
                
                const result = await response.json();
                console.log('Save result:', result);
                return result.success;
                
            } catch (error) {
                console.error('Save error:', error);
                return false;
            }
        }

        // Start the quiz
        async function startQuiz() {
            studentData = {
                name: document.getElementById('student-name').value.trim(),
                email: document.getElementById('student-email').value.trim(),
                id: document.getElementById('student-id').value.trim()
            };

            if (!studentData.name || !studentData.email || !studentData.id) {
                showStatus('Please fill in all fields', 'error');
                return;
            }

            // Generate session ID
            sessionId = 'quiz_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

            // Save session start
            const saved = await saveToSheets({
                sessionId: sessionId,
                studentName: studentData.name,
                studentId: studentData.id,
                studentEmail: studentData.email,
                eventType: 'session_start',
                timestamp: new Date().toISOString()
            });

            if (saved) {
                showStatus('‚úÖ Quiz started! Data saving is active.', 'success');
                document.getElementById('welcome-section').classList.remove('active');
                document.getElementById('quiz-section').classList.add('active');
                loadQuestion();
                startTimer();
            } else {
                showStatus('‚ùå Failed to start quiz session', 'error');
            }
        }

        function loadQuestion() {
            const q = questions[currentQuestion];
            document.getElementById('question-num').textContent = currentQuestion + 1;
            document.getElementById('question-text').textContent = q.question;
            
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            
            q.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'option-btn';
                button.textContent = option;
                button.onclick = () => selectOption(button, index);
                optionsContainer.appendChild(button);
            });
            
            // Reset timer for new question
            resetTimer();
        }

        function selectOption(button, selectedIndex) {
            // Remove selection from all buttons
            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Select current button
            button.classList.add('selected');
            
            // Enable next button
            document.getElementById('next-btn').disabled = false;
        }

        async function nextQuestion() {
            const selectedBtn = document.querySelector('.option-btn.selected');
            if (!selectedBtn) {
                alert('Please select an answer!');
                return;
            }

            const selectedIndex = Array.from(document.querySelectorAll('.option-btn')).indexOf(selectedBtn);
            const q = questions[currentQuestion];
            const isCorrect = selectedIndex === q.correct;
            
            if (isCorrect) {
                score += 10;
            }

            // Save answer to Google Sheets
            await saveToSheets({
                sessionId: sessionId,
                studentName: studentData.name,
                studentId: studentData.id,
                studentEmail: studentData.email,
                questionNumber: currentQuestion + 1,
                question: q.question,
                selectedAnswer: q.options[selectedIndex],
                correctAnswer: q.options[q.correct],
                isCorrect: isCorrect,
                score: score,
                totalScore: (currentQuestion + 1) * 10,
                eventType: 'answer'
            });

            currentQuestion++;
            
            if (currentQuestion < questions.length) {
                loadQuestion();
                document.getElementById('next-btn').disabled = true;
            } else {
                await finishQuiz();
            }
        }

        async function finishQuiz() {
            clearInterval(timer);
            
            // Save final results
            await saveToSheets({
                sessionId: sessionId,
                studentName: studentData.name,
                studentId: studentData.id,
                studentEmail: studentData.email,
                finalScore: score,
                totalQuestions: questions.length,
                percentage: ((score / (questions.length * 10)) * 100).toFixed(1) + '%',
                eventType: 'quiz_complete'
            });

            // Show results
            document.getElementById('quiz-section').classList.remove('active');
            document.getElementById('results-section').classList.add('active');
            document.getElementById('final-score').textContent = `${score}/${questions.length * 10}`;
        }

        function startTimer() {
            resetTimer();
            timer = setInterval(updateTimer, 1000);
        }

        function resetTimer() {
            timeLeft = 60;
            updateTimerDisplay();
        }

        function updateTimer() {
            timeLeft--;
            updateTimerDisplay();
            
            if (timeLeft <= 0) {
                clearInterval(timer);
                nextQuestion();
            }
        }

        function updateTimerDisplay() {
            document.getElementById('timer').textContent = timeLeft;
        }

        function restartQuiz() {
            location.reload();
        }

        // Initialize
        document.getElementById('next-btn').disabled = true;
    </script>
</body>
</html>