<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Assessment Quiz</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Math&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=STIX+Two+Math&display=swap" rel="stylesheet">
    <style>
        /* ... (Keep your existing CSS styles as they are) ... */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Nunito', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .quiz-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 800px;
            overflow: hidden;
        }

        .quiz-header {
            background: #2c5aa0;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .security-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 10px;
            text-align: center;
            font-size: 14px;
            color: #856404;
        }

        .quiz-content {
            padding: 30px;
        }

        .progress-container {
            margin-bottom: 20px;
        }

        .progress-bar {
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #2c5aa0;
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: right;
            font-size: 14px;
            color: #6c757d;
            margin-top: 5px;
        }

        .timer-container {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
        }

        .timer {
            font-size: 24px;
            font-weight: 700;
            color: #dc3545;
        }

        .question-container {
            margin-bottom: 25px;
        }

        .question-text {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .math-expression {
            font-family: 'STIX Two Math', 'Noto Sans Math', serif;
            font-size: 1.1em;
            padding: 5px 0;
            margin: 10px 0;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            border-left: 4px solid #2c5aa0;
        }

        .options-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .option {
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option:hover {
            border-color: #2c5aa0;
            background: #f8f9fa;
        }

        .option.selected {
            border-color: #2c5aa0;
            background: #e7f1ff;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 25px;
        }

        button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-prev {
            background: #6c757d;
            color: white;
        }

        .btn-next {
            background: #2c5aa0;
            color: white;
        }

        .btn-submit {
            background: #28a745;
            color: white;
        }

        .completion-screen {
            text-align: center;
            padding: 30px;
        }

        .completion-icon {
            font-size: 64px;
            color: #28a745;
            margin-bottom: 20px;
        }

        .completion-message {
            font-size: 24px;
            margin-bottom: 20px;
            color: #2c5aa0;
        }

        .loading-container {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #2c5aa0;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .math-option {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .option-letter {
            background: #2c5aa0;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .submission-status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .submission-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .submission-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .submission-loading {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .debug-info {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            margin-top: 10px;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="quiz-container">
        <div class="quiz-header">
            <h1>Online Assessment</h1>
            <p>Academic Integrity Required</p>
        </div>

        <div class="security-warning" id="security-warning">
            ⚠️ This assessment is monitored. Any attempt to cheat will be recorded.
        </div>

        <div class="quiz-content">
            <div id="loading-container" class="loading-container">
                <div class="spinner"></div>
                <p>Loading assessment...</p>
            </div>

            <div id="error-container" class="error-message" style="display: none;">
                <p>Error loading assessment. Please try again later.</p>
            </div>

            <div id="quiz-section" style="display: none;">
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <div class="progress-text" id="progress-text">Question 0 of 0</div>
                </div>

                <div class="timer-container">
                    <div>Time Remaining:</div>
                    <div class="timer" id="timer">60</div>
                </div>

                <div id="question-section">
                    <div class="question-container">
                        <div class="question-text" id="question-text"></div>
                        <div class="options-container" id="options-container"></div>
                    </div>

                    <div class="navigation">
                        <button class="btn-prev" id="prev-btn" onclick="previousQuestion()">Previous</button>
                        <button class="btn-next" id="next-btn" onclick="nextQuestion()">Next</button>
                    </div>
                </div>
            </div>

            <div id="completion-section" class="completion-screen" style="display: none;">
                <div class="completion-icon">✓</div>
                <div class="completion-message" id="completion-message">Assessment Submitted Successfully!</div>
                <p>Your responses have been recorded. Results will be available to your instructor.</p>
                <div id="submission-status" class="submission-status submission-loading">
                    <div class="spinner" style="width: 30px; height: 30px; border-width: 3px; display: inline-block;"></div>
                    <p>Submitting results to server...</p>
                </div>
                <div id="debug-info" class="debug-info" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        // Quiz configuration
        const config = {
            // Make sure this URL points to your CORRECTLY UPDATED Google Apps Script deployment
            submitUrl: 'https://script.google.com/macros/s/AKfycbyvh4-g5_GXiyGDol7AD-Lrb-jXOoNh8PGDoS48ks5wQAUbidgdgRMzlEbRRwN8Y0aRHA/exec',
            questionTime: 60,
            maxCheatingAttempts: 5,
            questionsUrl: 'questions.json' // Adjust if your questions file is elsewhere
        };

        // Quiz state
        let quizData = [];
        let currentQuestion = 0;
        let studentData = {
            studentId: generateStudentId(),
            studentName: prompt("Please enter your name:") || "Anonymous Student", // Simple prompt for name
            quizType: "Online Assessment",
            startTime: null, // Will be set when quiz starts
            answers: [],
            timePerQuestion: [],
            windowFocusLost: 0,
            tabSwitches: 0,
            cheatingAttempts: 0
        };

        let timeLeft = config.questionTime;
        let timerInterval = null;
        let questionStartTime = null;

        async function initQuiz() {
            try {
                await loadQuestions();
                document.getElementById('loading-container').style.display = 'none';
                document.getElementById('quiz-section').style.display = 'block';
                setupAntiCheating();
                studentData.startTime = new Date(); // Set start time after initialization
                showQuestion();
            } catch (error) {
                console.error('Error initializing quiz:', error);
                document.getElementById('loading-container').style.display = 'none';
                document.getElementById('error-container').style.display = 'block';
                document.getElementById('error-container').innerHTML = `<p>Error loading assessment: ${error.message || 'Unknown error'}</p>`;
            }
        }

        async function loadQuestions() {
            try {
                const response = await fetch(config.questionsUrl);
                if (!response.ok) {
                    throw new Error(`Failed to load questions: ${response.status} ${response.statusText}`);
                }
                quizData = await response.json();
                if (!Array.isArray(quizData) || quizData.length === 0) {
                    throw new Error('Loaded questions data is not a valid array or is empty.');
                }
                studentData.answers = new Array(quizData.length).fill(null);
                studentData.timePerQuestion = new Array(quizData.length).fill(0);
            } catch (error) {
                console.error('Error loading questions:', error);
                quizData = getFallbackQuestions(); // Use fallback if external load fails
                studentData.answers = new Array(quizData.length).fill(null);
                studentData.timePerQuestion = new Array(quizData.length).fill(0);
            }
        }

        function getFallbackQuestions() {
            return [
                {
                    "question": "Solve the equation for x:",
                    "mathExpression": "2x + 5 = 13",
                    "options": ["x = 4", "x = 5", "x = 6", "x = 7"],
                    "correctAnswer": 0
                },
                {
                    "question": "What is the integral of x² from 0 to 1?",
                    "mathExpression": "∫₀¹ x² dx",
                    "options": ["1/2", "1/3", "1/4", "1/5"],
                    "correctAnswer": 1
                },
                {
                    "question": "Simplify the expression:",
                    "mathExpression": "√16 + ∛27",
                    "options": ["5", "6", "7", "8"],
                    "correctAnswer": 2
                },
                {
                    "question": "What is the derivative of f(x) = 3x³ - 2x² + 5x - 7?",
                    "mathExpression": "",
                    "options": ["9x² - 4x + 5", "6x² - 4x + 5", "9x² - 2x + 5", "6x² - 2x + 5"],
                    "correctAnswer": 0
                },
                {
                    "question": "Solve the quadratic equation:",
                    "mathExpression": "x² - 5x + 6 = 0",
                    "options": ["x = 2, x = 3", "x = 1, x = 6", "x = -2, x = -3", "x = -1, x = -6"],
                    "correctAnswer": 0
                }
            ];
        }

        function setupAntiCheating() {
            let visibilityStartTime = null;

            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    visibilityStartTime = new Date();
                } else if (visibilityStartTime) {
                    const timeAway = (new Date() - visibilityStartTime) / 1000;
                    if (timeAway > 2) {
                        studentData.tabSwitches++;
                        studentData.cheatingAttempts++;
                        console.warn("Potential tab switch detected. Cheating attempts:", studentData.cheatingAttempts);
                    }
                    visibilityStartTime = null;
                }
            });

            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                studentData.cheatingAttempts++;
                console.warn("Right-click prevented. Cheating attempts:", studentData.cheatingAttempts);
                return false;
            });

            // Disable common dev tools shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.key === 'F12' ||
                    (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J' || e.key === 'C')) ||
                    (e.ctrlKey && e.key === 'u')) { // Disable Ctrl+U (View Source)
                    e.preventDefault();
                    studentData.cheatingAttempts++;
                    console.warn("Dev tools shortcut blocked. Cheating attempts:", studentData.cheatingAttempts);
                    return false;
                }
            });
        }

        function startTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            timeLeft = config.questionTime;
            updateTimerDisplay();
            questionStartTime = new Date();

            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                if (timeLeft <= 0) {
                    nextQuestion(); // Automatically move to next question when time runs out
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            document.getElementById('timer').textContent = timeLeft;
            if (timeLeft < 10) {
                document.getElementById('timer').style.color = '#dc3545';
            } else if (timeLeft < 30) {
                document.getElementById('timer').style.color = '#fd7e14';
            }
        }

        function showQuestion() {
            if (currentQuestion < 0 || currentQuestion >= quizData.length) {
                 console.error("Invalid question index:", currentQuestion);
                 return;
            }
            const question = quizData[currentQuestion];
            const questionText = document.getElementById('question-text');
            questionText.innerHTML = question.question;

            // Clear any previous math expressions
            const existingMath = questionText.querySelector('.math-expression');
            if (existingMath) {
                existingMath.remove();
            }

            if (question.mathExpression) {
                const mathElement = document.createElement('div');
                mathElement.className = 'math-expression';
                mathElement.innerHTML = question.mathExpression;
                questionText.appendChild(mathElement);
            }

            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';

            question.options.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'option';
                if (studentData.answers[currentQuestion] === index) {
                    optionElement.classList.add('selected');
                }

                const optionContent = document.createElement('div');
                optionContent.className = 'math-option';

                const letterSpan = document.createElement('span');
                letterSpan.className = 'option-letter';
                letterSpan.textContent = ['A', 'B', 'C', 'D'][index];

                const textSpan = document.createElement('span');
                if (option.includes('π') || option.includes('∫') || option.includes('√') || option.includes('x =')) {
                    textSpan.className = 'math-expression';
                    textSpan.style.background = 'transparent';
                    textSpan.style.borderLeft = 'none';
                    textSpan.style.padding = '0';
                    textSpan.style.margin = '0';
                }
                textSpan.innerHTML = option;

                optionContent.appendChild(letterSpan);
                optionContent.appendChild(textSpan);
                optionElement.appendChild(optionContent);
                optionElement.onclick = () => selectAnswer(index);
                optionsContainer.appendChild(optionElement);
            });

            updateProgress();
            updateNavigation();
            startTimer(); // Start timer for the new question
        }

        function selectAnswer(answerIndex) {
            if (studentData.answers[currentQuestion] === answerIndex) {
                // Deselect if the same option is clicked again
                studentData.answers[currentQuestion] = null;
                const options = document.querySelectorAll('.option');
                options.forEach(option => option.classList.remove('selected'));
            } else {
                // Record the new answer and time spent on this question so far
                const timeSpent = Math.round((new Date() - questionStartTime) / 1000);
                studentData.timePerQuestion[currentQuestion] = timeSpent;
                studentData.answers[currentQuestion] = answerIndex;

                const options = document.querySelectorAll('.option');
                options.forEach((option, index) => {
                    option.classList.toggle('selected', index === answerIndex);
                });
            }
        }

        function updateProgress() {
            const progress = ((currentQuestion + 1) / quizData.length) * 100;
            document.getElementById('progress-fill').style.width = `${progress}%`;
            document.getElementById('progress-text').textContent = `Question ${currentQuestion + 1} of ${quizData.length}`;
        }

        function updateNavigation() {
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');

            prevBtn.disabled = currentQuestion === 0;
            prevBtn.style.opacity = prevBtn.disabled ? '0.5' : '1';
            prevBtn.style.cursor = prevBtn.disabled ? 'not-allowed' : 'pointer';

            if (currentQuestion === quizData.length - 1) {
                nextBtn.textContent = 'Submit';
                nextBtn.className = 'btn-submit';
            } else {
                nextBtn.textContent = 'Next';
                nextBtn.className = 'btn-next';
            }
        }

        function previousQuestion() {
            if (currentQuestion > 0) {
                // Record time spent on current question before navigating
                if (questionStartTime) {
                     const timeSpent = Math.round((new Date() - questionStartTime) / 1000);
                     studentData.timePerQuestion[currentQuestion] = timeSpent;
                }
                clearInterval(timerInterval); // Stop current timer
                currentQuestion--;
                showQuestion();
            }
        }

        function nextQuestion() {
            // Record time spent on current question before navigating
             if (questionStartTime) {
                 const timeSpent = Math.round((new Date() - questionStartTime) / 1000);
                 studentData.timePerQuestion[currentQuestion] = timeSpent;
             }
             clearInterval(timerInterval); // Stop current timer

            if (currentQuestion < quizData.length - 1) {
                currentQuestion++;
                showQuestion();
            } else {
                submitQuiz();
            }
        }

        async function submitQuiz() {
            try {
                // Ensure timer is stopped
                if (timerInterval) {
                    clearInterval(timerInterval);
                }
                // Record final question time if not already recorded
                if (questionStartTime && studentData.timePerQuestion[currentQuestion] === 0) {
                     const timeSpent = Math.round((new Date() - questionStartTime) / 1000);
                     studentData.timePerQuestion[currentQuestion] = timeSpent;
                }

                const endTime = new Date();
                studentData.endTime = endTime;
                studentData.totalTime = Math.round((endTime - studentData.startTime) / 1000);

                let score = 0;
                quizData.forEach((question, index) => {
                    if (studentData.answers[index] === question.correctAnswer) {
                        score++;
                    }
                });

                // Calculate deductions for cheating attempts
                const totalDeductions = Math.min(studentData.cheatingAttempts * 2, score); // Cap deductions at score
                let finalScore = Math.max(0, score - totalDeductions);

                studentData.score = score;
                studentData.finalScore = finalScore;
                studentData.totalDeductions = totalDeductions;
                studentData.percentage = quizData.length > 0 ? Math.round((finalScore / quizData.length) * 100) : 0;

                console.log("Submitting data:", JSON.stringify(studentData, null, 2)); // Debug log

                // Show completion screen
                document.getElementById('quiz-section').style.display = 'none';
                document.getElementById('completion-section').style.display = 'block';

                // Submit to Google Apps Script
                await submitToGoogleAppsScript(studentData);

            } catch (error) {
                console.error('Error during quiz submission:', error);
                showSubmissionError(error);
            }
        }

        async function submitToGoogleAppsScript(data) {
            const statusElement = document.getElementById('submission-status');
            const debugElement = document.getElementById('debug-info');

            try {
                const submissionData = {
                    action: 'submitQuiz',
                    timestamp: new Date().toISOString(),
                    data: data
                };

                console.log('Submitting data to Google Apps Script:', submissionData);

                // Show debug info
                debugElement.style.display = 'block';
                debugElement.innerHTML = `
                    <strong>Debug Information:</strong><br>
                    Submitting to: ${config.submitUrl}<br>
                    Student ID: ${data.studentId}<br>
                    Score: ${data.score}/${quizData.length}<br>
                    Data size: ${JSON.stringify(submissionData).length} characters<br>
                    Cheating Attempts: ${data.cheatingAttempts}
                `;

                const response = await fetch(config.submitUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(submissionData)
                });

                console.log('Response status:', response.status);

                if (!response.ok) {
                    // Try to get error details from response body
                    let errorMessage = `HTTP error! status: ${response.status}`;
                    try {
                        const errorBody = await response.text(); // GAS usually returns JSON, but let's try text first
                        console.log("Response Text:", errorBody);
                        // Attempt to parse as JSON if possible
                        try {
                            const errorJson = JSON.parse(errorBody);
                            errorMessage = errorJson.error || errorJson.message || errorMessage;
                        } catch {
                            // If not JSON, use the text as the error message
                            errorMessage = errorBody || errorMessage;
                        }
                    } catch (e) {
                        console.error("Could not read error response body:", e);
                        // errorMessage remains the HTTP status error
                    }
                    throw new Error(errorMessage);
                }

                const result = await response.json();
                console.log('Server response:', result);

                if (result.success) {
                    statusElement.className = 'submission-status submission-success';
                    statusElement.innerHTML = `
                        <strong>✓ Data successfully saved to Google Sheets!</strong><br>
                        <small>Submission ID: ${result.submissionId || 'N/A'}</small><br>
                        <small>${result.message || 'Data recorded successfully'}</small>
                    `;
                    debugElement.innerHTML += `<br><br><strong>Success Response:</strong><br>${JSON.stringify(result, null, 2)}`;
                } else {
                    // Server returned success=false
                    throw new Error(result.error || result.message || 'Unknown server error');
                }

            } catch (error) {
                console.error('Submission error:', error);
                statusElement.className = 'submission-status submission-error';
                statusElement.innerHTML = `
                    <strong>⚠️ Failed to save to Google Sheets</strong><br>
                    <small>Error: ${error.message}</small><br>
                    <small>Check console for details. Data may be saved locally as backup.</small>
                `;
                debugElement.innerHTML += `<br><br><strong>Error:</strong> ${error.message}`;

                // Save locally as backup
                try {
                    localStorage.setItem('quiz_backup_' + data.studentId, JSON.stringify(data));
                    console.log('Data saved locally as backup');
                    statusElement.innerHTML += `<br><small>Data saved locally as backup.</small>`;
                } catch (lsError) {
                    console.error("Failed to save backup to localStorage:", lsError);
                    statusElement.innerHTML += `<br><small>Failed to save backup locally.</small>`;
                }
            }
        }


        function showSubmissionError(error) {
            const statusElement = document.getElementById('submission-status');
            statusElement.className = 'submission-status submission-error';
            statusElement.innerHTML = `
                <strong>⚠️ Submission Error</strong><br>
                <small>${error.message}</small><br>
                <small>Your data may have been saved locally.</small>
            `;
            // Attempt to save backup if not already done in submitToGoogleAppsScript
             if (typeof localStorage !== 'undefined') {
                 try {
                     localStorage.setItem('quiz_backup_' + studentData.studentId, JSON.stringify(studentData));
                     console.log('Data saved locally as backup in error handler');
                 } catch (e) {
                     console.error("Failed to save backup in error handler:", e);
                 }
             }
        }

        function generateStudentId() {
            return 'S' + Math.random().toString(36).substr(2, 9).toUpperCase();
        }

        // Initialize when page loads
        window.onload = initQuiz;
    </script>
</body>
</html>